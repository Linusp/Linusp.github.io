<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="SzhNnSrJlB" />
    
    <meta name="author" content="Linusp">
    <title>
      
      使用elisp编写脚本
      
    </title>
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/css/bootstrap.css" rel="stylesheet">
    <link href="/assets/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link rel="alternate" type="application/ato+xml" title="Linusp's Blog RSS Feed" href="/atom.xml" />
    <link rel="shortcut icon" href="/assets/img/favicon.ico">
    <script type="text/javascript" src="http://orgmode.org/mathjax/MathJax.js"></script>
    <script type="text/javascript">
      <!--/*--><![CDATA[/*><!--*/
    MathJax.Hub.Config({
        // Only one of the two following lines, depending on user settings
        // First allows browser-native MathML display, second forces HTML/CSS
        //  config: ["MMLorHTML.js"], jax: ["input/TeX"],
            jax: ["input/TeX", "output/HTML-CSS"],
        extensions: ["tex2jax.js","TeX/AMSmath.js","TeX/AMSsymbols.js",
                     "TeX/noUndefined.js"],
        tex2jax: {
            inlineMath: [ ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"], ["\\begin{displaymath}","\\end{displaymath}"] ],
            skipTags: ["script","noscript","style","textarea","pre","code"],
            ignoreClass: "tex2jax_ignore",
            processEscapes: false,
            processEnvironments: true,
            preview: "TeX"
        },
        showProcessingMessages: true,
        displayAlign: "center",
        displayIndent: "2em",

        "HTML-CSS": {
             scale: 100,
             availableFonts: ["STIX","TeX"],
             preferredFont: "TeX",
             webFont: "TeX",
             imageFont: "TeX",
             showMathMenu: true,
        },
        MMLorHTML: {
             prefer: {
                 MSIE:    "MML",
                 Firefox: "MML",
                 Opera:   "HTML",
                 other:   "HTML"
             }
        }
    });
    /*]]>*///-->
    </script>
  </head>

  <body>

    <div class="topbar">
      <div class="fill">
        <div class="container">
          <a class="brand" href="/index.html">Linusp's Blog</a>
          <ul class="nav">
	    
	    
	    
	    <li><a href="/categories.html">分类</a></li>
	    
	    
	    
	    
	    <li><a href="/tags.html">标签</a></li>
	    
	    
	    
	    
	    <li><a href="/archive.html">存档</a></li>
	    
	    
	    
	    
	    <li><a href="/link.html">链接</a></li>
	    
	    
	    
	    
	    <li><a href="/about.html">关于</a></li>
	    
	    
	    <li><a href="/atom.xml" target="_blank">Feed</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container">

      <div class="content">
        
<div class="page-header">
  <h1>使用elisp编写脚本</h1>
</div>

<div class="row">
  <div class="span10">
    <div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">起因</h2>
<div class="outline-text-2" id="text-1">
<p>
我通过Github Pages有了自己的一个静态博客，并且开始正儿八经地写博客。
</p>

<p>
但我碰到了一个问题：每次我需要写博客，我要先打开emacs，按下C-x C-f，然后输入一长串路径名和文件名(org文件)，然后手动输入YAML Front Matter<sup><a id="fnr.1" name="fnr.1" class="footref" href="#fn.1">1</a></sup>。路径名每次都是一样的，YAML Front Matter也是一样的，这都是重复性的工作，并且我又是一个很懒的人，所以我就想偷懒了。
</p>

<p>
起初是想写个shell脚本来简化步骤而已，开始写脚本后，我就想，应该把publish的步骤也通过脚本进行简化(虽然这并不是很复杂的步骤)，然后我发现shell不能做到这一点，唯一的选择是elisp。
</p>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">过程</h2>
<div class="outline-text-2" id="text-2">
<p>
用elisp写脚本？这事我听说过，但我没做过，也就是说我也是大姑娘上轿头一回了。
</p>

<p>
照例google。
</p>

<p>
基本形式没太大问题，将shell脚本Shebang<sup><a id="fnr.2" name="fnr.2" class="footref" href="#fn.2">2</a></sup>后面的 <b>/bin/bash</b> 改成 <b>/usr/bin/emacs &#x2013;script</b> ，其他的东西嘛，随便就行不是么？（想当年某次实习招聘的时候我跟面试官说我会shell脚本，结果只会堆命令的真相还是被不留情面地揭穿了（╯‵□′）╯︵┴─┴ ）
</p>

<p>
不过碰到了不少问题。
</p>

<ol class="org-ol">
<li>之所以用elisp，就是想简化publish么，但是在elisp script里写上的
<div class="org-src-container">

<pre class="src src-lisp">(org-publish-project <span style="color: #25ef29;">"blog-linusp"</span>)
</pre>
</div>
<p>
完全不起作用。细想一下应该是shell脚本没有加载我的emacs相关配置。当时真是一筹莫展啊，后来发现其实这是一件不复杂的事情，在之前加上一句
</p>
<div class="org-src-container">

<pre class="src src-lisp">(load-file <span style="color: #25ef29;">"~/.emacs"</span>)
</pre>
</div>
<p>
不过这样做太凶残了，什么auto-complete、yasnippet、slime、org2blog、metablog全被加载了（╯‵□′）╯︵┴─┴ 。
</p>

<p>
好在我有将配置文件分类的习惯，org-mode的相关配置被我写在一个名为 <b>org.el</b> 的文件里，于是加载它就OK了，不过这个文件里还有引用其他的一些emacs插件，于是也都加载了——好吧至少比之前更好是吧。
</p>
</li>
<li>如何传递参数给脚本？shell脚本接受参数的话还是懂的怎么做的，可是elisp脚本……

<p>
照例google，然后发现Xah Lee<sup><a id="fnr.3" name="fnr.3" class="footref" href="#fn.3">3</a></sup>的博客上就有这个内容，原文点<a href="http://ergoemacs.org/emacs/elisp_command_line_argv.html">我</a>。
</p>
</li>
<li>运行脚本后，发现总会有一堆的Loading message，就像下面这样：
<img src="/assets/img/2013-10-09-loading-message.png" />

<p>
（╯‵□′）╯︵┴─┴ 
</p>

<p>
经google，该问题没有太好的解决问题，凑合吧。
</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">成果</h2>
<div class="outline-text-2" id="text-3">
<p>
嘛，虽然代码写得比较丑陋，至少能用，功能上达到了我的预期目标，所以代码的问题，以后再说吧。
</p>

<p>
附脚本代码
</p>
<div class="org-src-container">

<pre class="src src-lisp">#!/usr/bin/emacs --script

(<span style="color: #cf4a44;">require</span> '<span style="color: #bebebe;">calendar</span>)
(<span style="color: #cf4a44;">defun</span> <span style="color: #ed8a0c;">blog</span> (action <span style="color: #ca34e2;">&amp;rest</span> rst)
  (<span style="color: #cf4a44;">cond</span> ((string-equal action <span style="color: #25ef29;">"post"</span>)
     (<span style="color: #cf4a44;">if</span> (equal rst nil)
         (print <span style="color: #25ef29;">"Please input title"</span>)
       (<span style="color: #cf4a44;">let</span> ((post-file (concat (format-time-string <span style="color: #25ef29;">"%Y-%m-%d"</span>)
                     <span style="color: #25ef29;">"-"</span>
                     (car rst)
                     <span style="color: #25ef29;">".org"</span>)))
         (<span style="color: #cf4a44;">progn</span>
           (<span style="color: #cf4a44;">with-temp-file</span> (concat <span style="color: #25ef29;">"~/blog/org/_posts/"</span>
                       post-file)
         (insert (concat <span style="color: #25ef29;">"#+begin_html\n"</span>
                 <span style="color: #25ef29;">"---\n"</span>
                 <span style="color: #25ef29;">"layout     : post\n"</span>
                 <span style="color: #25ef29;">"title      : \n"</span>
                 <span style="color: #25ef29;">"categories : \n"</span>
                 <span style="color: #25ef29;">"tags       : \n"</span>
                 <span style="color: #25ef29;">"excerpt    : \n"</span>
                 <span style="color: #25ef29;">"---\n"</span>
                 <span style="color: #25ef29;">"#+end_html\n"</span>)))
           (print (format <span style="color: #25ef29;">"Create post file %s in post directory"</span> post-file))
           (shell-command (concat <span style="color: #25ef29;">"emacs "</span>
                      <span style="color: #25ef29;">"~/blog/org/_posts/"</span>
                      post-file))))))
     ((string-equal action <span style="color: #25ef29;">"publish"</span>)
      (<span style="color: #cf4a44;">progn</span><span style="color: #a07f41; background-color: #073642;"> </span>
        (org-publish-project <span style="color: #25ef29;">"blog-linusp"</span>)
        (print <span style="color: #25ef29;">"Project has been published!"</span>)))
    (t (print <span style="color: #25ef29;">"Action: post/publish"</span>))))

(load-file <span style="color: #25ef29;">"~/.emacs.d/site-lisp/xml-rpc.el"</span>)
(load-file <span style="color: #25ef29;">"~/.emacs.d/site-lisp/wc-mode.el"</span>)
(load-file <span style="color: #25ef29;">"~/.emacs.d/myplugins/org.el"</span>)

(blog (elt argv 0) (elt argv 1))
</pre>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">&#33050;&#27880;: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" name="fn.1" class="footnum" href="#fnr.1">1</a></sup> <p class="footpara">
<a href="http://jekyllrb.com/docs/frontmatter/">YAML Front Matter</a>是用来告诉Jekyll使用什么模板并可以附带一些其他信息的文件头
</p></div>

<div class="footdef"><sup><a id="fn.2" name="fn.2" class="footnum" href="#fnr.2">2</a></sup> <p class="footpara">
Shebang是一个由'#'和'!'构成的字符串，在文件中存在Shebang的情况下，类Unix操作系统的程序载入器会分析Shebang后的内容，将这些内容作为解释器指令，并调用该指令，并将载有Shebang的文件路径作为该解释器的参数——来自<a href="http://zh.wikipedia.org/wiki/Shebang">维基百科</a>
</p></div>

<div class="footdef"><sup><a id="fn.3" name="fn.3" class="footnum" href="#fnr.3">3</a></sup> <p class="footpara">
Xah Lee是一位emacs大牛，emacs wiki上可是都有他的专门的页面哦
</p></div>


</div>
</div>

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2013/10/07/one-year.html" title="一年">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/2013/10/10/free-in-internet-time.html" title="论信息自由">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    <!-- Duoshuo Comment BEGIN -->
    <div class="ds-thread"></div>
    <script type="text/javascript">
      var duoshuoQuery = {short_name:"linuspb"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		|| document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
    </script>
    <!-- Duoshuo Comment END -->
  </div>
  
  <div class="span4">
    <h4>发布日期</h4>
    <div class="date"><span>2013年 10月 09日</span></div>

  
    <h4>类别</h4>
    <ul class="tag_box">
    
    


  
     
    	<li><a href="/categories.html#编程-ref">
    		编程 <span>5</span>
    	</a></li>
    
  


    </ul>
    

  
    <h4>标签</h4>
    <ul class="tag_box">
    
    


  
     
    	<li><a href="/tags.html#lisp-ref">lisp <span>3</span></a></li>
    
  



    </ul>
    
  </div>
</div>

      </div>

      <footer>
        <p>
	  Powered by <a href="http://jekyllrb.com" target="_blank">Jekyll</a>
	  and <a href="http://pages.github.com" target="_blank">Github Pages</a> | 
	  &copy; Linusp 2013
        </p>
      </footer>

    </div> <!-- /container -->

    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-44461305-1', 'linusp.github.io');
      ga('send', 'pageview');
    </script>
  </body>
</html>
